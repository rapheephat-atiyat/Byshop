// Class นี้สร้างโดย FB: Rapheephat atiyat อยากได้ open source ติดต่อมาสอบถามราคา

const _0x4cdb2e=_0x59e0;function _0x59e0(_0x29d33c,_0x2ba613){const _0x38bcd7=_0x38bc();return _0x59e0=function(_0x59e0db,_0x12a132){_0x59e0db=_0x59e0db-0x189;let _0x14a10c=_0x38bcd7[_0x59e0db];return _0x14a10c;},_0x59e0(_0x29d33c,_0x2ba613);}(function(_0xe171bd,_0xd9aeae){const _0x392655=_0x59e0,_0x81b333=_0xe171bd();while(!![]){try{const _0x131181=-parseInt(_0x392655(0x18b))/0x1+-parseInt(_0x392655(0x1c0))/0x2*(-parseInt(_0x392655(0x18e))/0x3)+parseInt(_0x392655(0x19e))/0x4+parseInt(_0x392655(0x189))/0x5+parseInt(_0x392655(0x18c))/0x6*(parseInt(_0x392655(0x1b4))/0x7)+-parseInt(_0x392655(0x1b2))/0x8*(-parseInt(_0x392655(0x1b7))/0x9)+-parseInt(_0x392655(0x1a5))/0xa*(parseInt(_0x392655(0x1b0))/0xb);if(_0x131181===_0xd9aeae)break;else _0x81b333['push'](_0x81b333['shift']());}catch(_0x5af7e3){_0x81b333['push'](_0x81b333['shift']());}}}(_0x38bc,0x7256b));const config=require(_0x4cdb2e(0x1a3)),{PrismaClient}=require(_0x4cdb2e(0x19b)),Logger=require('./Logger'),prisma=new PrismaClient();class QRPayment{#apiURL;#headers;#body;constructor(){const _0x3a53a1=_0x4cdb2e;this['promtpayIO']=_0x3a53a1(0x1bb),this.#apiURL=_0x3a53a1(0x1b5),this.#headers={'content-type':_0x3a53a1(0x199),'x-hmac':config[_0x3a53a1(0x1ba)][_0x3a53a1(0x1b1)][_0x3a53a1(0x19d)],'x-line-access':config['payment'][_0x3a53a1(0x1b1)]['x-line-access'],'x-line-chrome-version':_0x3a53a1(0x19f)},this.#body=[config[_0x3a53a1(0x1ba)][_0x3a53a1(0x1b1)]['chatID'],0x32];}async #getTransaction({transaction:_0x55e633}){const _0x5b47a9=_0x4cdb2e,_0x299165=await prisma[_0x5b47a9(0x196)][_0x5b47a9(0x198)]({'where':{'id':_0x55e633}});return _0x299165;}async[_0x4cdb2e(0x1af)]({transaction:_0x2f21af}){const _0x5e8d47=_0x4cdb2e;try{const _0x43e4e1=await this.#fetchRecentMessages();if(!_0x43e4e1?.['data'])return{'success':![]};const _0x28dd29=await this.#getTransaction({'transaction':_0x2f21af});if(!_0x28dd29)return{'success':![]};const _0x134e68=_0x28dd29[_0x5e8d47(0x1bd)][_0x5e8d47(0x1bf)](),_0x9e72b2=0xa*0x3c*0x3e8,_0x5c7394=_0x43e4e1['data'][_0x5e8d47(0x194)](_0x1a32f9=>{const _0x5648cd=_0x5e8d47,_0x2d20fb=Number(_0x1a32f9[_0x5648cd(0x19c)]);return _0x2d20fb>=_0x134e68&&_0x2d20fb<=_0x134e68+_0x9e72b2;});if(!_0x5c7394[_0x5e8d47(0x193)])return{'success':![]};const _0x43cdaf=JSON[_0x5e8d47(0x19a)](_0x5c7394[0x0][_0x5e8d47(0x18d)][_0x5e8d47(0x1be)]),_0x193f93=_0x43cdaf['contents'][0x0][_0x5e8d47(0x1ac)][_0x5e8d47(0x1ad)],_0x2a8e74=_0x193f93[0x0]['contents'][0x1]['contents'][0x0][_0x5e8d47(0x18a)],_0x30e6d3=_0x193f93[0x0][_0x5e8d47(0x1ad)][0x1][_0x5e8d47(0x1ad)][0x1][_0x5e8d47(0x18a)],_0x4825a4=_0x193f93[0x2][_0x5e8d47(0x1ad)][0x0][_0x5e8d47(0x1ad)][0x1]['text'],_0x14066e=_0x193f93[0x2][_0x5e8d47(0x1ad)][0x1][_0x5e8d47(0x1ad)][0x1][_0x5e8d47(0x18a)],_0x2d66e7=parseFloat(_0x14066e[_0x5e8d47(0x1aa)](/[^0-9.]/g,''));return _0x2d66e7===_0x28dd29[_0x5e8d47(0x1a1)]&&_0x2a8e74==='รายการเงินเข้า'?(await prisma[_0x5e8d47(0x196)]['update']({'where':{'id':_0x28dd29['id']},'data':{'status':'COMPLETED'}}),{'success':!![],'data':{'title':_0x2a8e74,'date':_0x30e6d3,'account':_0x4825a4,'amount':_0x14066e}}):{'success':![]};}catch(_0x56a0d1){return Logger[_0x5e8d47(0x1a2)](_0x5e8d47(0x190),_0x56a0d1),{'success':![]};}}async #fetchRecentMessages(){const _0x26999e=_0x4cdb2e,_0x4653a5=await fetch(this.#apiURL,{'headers':this.#headers,'body':JSON[_0x26999e(0x1a6)](this.#body),'method':_0x26999e(0x1a0)}),_0x5989a0=await _0x4653a5[_0x26999e(0x1ab)]();return console[_0x26999e(0x1ae)](_0x5989a0),_0x5989a0;}async #findOrCreateUser(_0x265da9){const _0x372d11=_0x4cdb2e;let _0x25bec4=await prisma[_0x372d11(0x1a8)]['findUnique']({'where':{'discordId':_0x265da9}});return!_0x25bec4&&(_0x25bec4=await prisma[_0x372d11(0x1a8)]['create']({'data':{'discordId':_0x265da9}}),Logger['info']('New\x20user\x20created:',_0x25bec4['id'])),_0x25bec4;}async[_0x4cdb2e(0x1b6)]({userId:_0x32a0a0,baseAmount:_0x48454c}){const _0x350612=_0x4cdb2e;try{if(!_0x32a0a0||!_0x48454c)throw new Error(_0x350612(0x195));const _0x31ced2=await this.#findOrCreateUser(_0x32a0a0),_0x1bc4b2=await prisma[_0x350612(0x196)][_0x350612(0x18f)]({'where':{'status':_0x350612(0x197),'amount':{'gte':_0x48454c,'lt':_0x48454c+0x1}},'select':{'amount':!![]},'orderBy':{'amount':_0x350612(0x191)}}),_0x5a2d17=_0x1bc4b2[_0x350612(0x1a7)](_0x15f59e=>Number(_0x15f59e[_0x350612(0x1a1)][_0x350612(0x192)](0x2)));let _0x8b12b0=_0x48454c;const _0xc3d88=0x63;let _0x2268d4=![];for(let _0x3074a8=0x0;_0x3074a8<=_0xc3d88;_0x3074a8++){const _0x146aff=Number((_0x48454c+_0x3074a8*0.01)[_0x350612(0x192)](0x2));if(!_0x5a2d17[_0x350612(0x1a4)](_0x146aff)){_0x8b12b0=_0x146aff,_0x2268d4=!![];break;}}if(!_0x2268d4)return{'success':![],'transaction':undefined,'createdAt':undefined,'expireAtUnix':undefined,'img':undefined};const _0x2a2284=await prisma[_0x350612(0x196)][_0x350612(0x1b8)]({'data':{'userId':_0x31ced2['id'],'amount':_0x8b12b0,'status':'PENDING'}}),_0x1303f2=new Date(_0x2a2284['createdAt'][_0x350612(0x1bf)]()+0xa*0x3c*0x3e8),_0x2d811a=Math[_0x350612(0x1b9)](_0x1303f2['getTime']()/0x3e8);return{'success':!![],'transaction':_0x2a2284['id'],'createdAt':_0x2a2284['createdAt'],'expireAtUnix':_0x2d811a,'img':this[_0x350612(0x1a9)]+'/'+config[_0x350612(0x1ba)][_0x350612(0x1b1)][_0x350612(0x1b3)]+'/'+_0x8b12b0};}catch(_0x403fbb){throw _0x403fbb;}}}module[_0x4cdb2e(0x1bc)]=QRPayment;function _0x38bc(){const _0x25b3bb=['length','filter','Missing\x20userId\x20or\x20amount','transaction','PENDING','findUnique','application/json','parse','../generated/prisma','createdTime','x-hmac','3251464PJAssR','3.7.1','POST','amount','error','../config/config.json','includes','20wDutWO','stringify','map','user','promtpayIO','replace','json','body','contents','log','confirmTransaction','11204061IxdVWl','promtpay','8WYUjtF','number','7etmYLY','https://line-chrome-gw.line-apps.com/api/talk/thrift/Talk/TalkService/getRecentMessagesV2','createTransaction','5063571fKTamC','create','floor','payment','https://promptpay.io','exports','createdAt','FLEX_JSON','getTime','92sHoIRH','1643510cFfuQy','text','99780vRKYNZ','351492apOgyt','contentMetadata','54942VOWTof','findMany','Error\x20in\x20confirmTransaction:','asc','toFixed'];_0x38bc=function(){return _0x25b3bb;};return _0x38bc();}